For this Attack to work the machine needs to be vulnerable to NOPAC Attacks specifically tied to CVE-2021-42278 and CVE-2021-42287. 

<p align="justify">The **NoPAC vulnerability** refers to the combination of **two Windows Active Directory vulnerabilities** that, when used together, allow **privilege escalation** — letting an attacker go from a regular domain user to **Domain Admin** under the right conditions.</p>

### sAMAccountName Spoofing:

- **sAMAccountName** is an Active Directory attribute used to identify user and computer accounts.
- Normally, computer accounts end with a **$** symbol, distinguishing them from user accounts.
- If a domain user has sufficient privileges on a machine account, they can modify the **sAMAccountName** of that account to match the name of a **Domain Controller** without the **$** symbol, setting up a scenario for impersonation.

1. **Exploitation Process**:
    
    - The attacker modifies the **sAMAccountName** of a machine account to match the name of a Domain Controller (e.g., `DC01` becomes `DC01` without the `$`).
        
    - They then request a **Ticket Granting Ticket (TGT)** from the **Key Distribution Center (KDC)** using the modified **sAMAccountName**.
        
    - The **KDC** checks for the account, doesn't find it, and appends a **$** to the name, leading to a match with a legitimate **Domain Controller** account.
        
    - The KDC then issues a **Service Ticket** with **Domain Controller** privileges, allowing the attacker to impersonate a Domain Controller.
        
2. **CVE-2021-42278**:
    
    - This vulnerability occurs due to the lack of restrictions on modifications to the **sAMAccountName** attribute, allowing a Domain User to modify it and impersonate a Domain Controller.
        
3. **CVE-2021-42287**:
    
    - Exploits the behavior of the KDC during the **Service Ticket request** phase. When an attacker requests a service ticket for a non-existent account, the KDC appends a **$** to search again, unintentionally matching the legitimate **Domain Controller** account.
        
4. **Privilege Attribute Certificate (PAC)**:
    
    - A **PAC** is a data structure used in **Kerberos authentication** to enforce access control based on the user’s identity and group memberships.
        
    - A PAC contains:
        - **User SID**: Unique identifier for the user.
        - **Group SIDs**: Identifiers for groups the user belongs to.
        - **User Rights**: The user’s privileges.
        - **Logon Information**: Session details, like logon time.

    - The absence of a PAC in Kerberos tickets (as in the **NoPAC vulnerability**) can bypass or improperly enforce security, leading to security risks.
        

### **The Attack Flow**:

1. Modify **sAMAccountName** to spoof a **Domain Controller** name.
    
2. Request a **TGT** using the modified name.
    
3. KDC appends a **$** sign and mistakenly issues a **Service Ticket** for the Domain Controller.
    
4. The attacker can now impersonate a Domain Controller, gaining unauthorized access.

### Enum from Linux
- use netexec and nopac scanner  to check for nopac vulnerability

### Abusing sAMAccountName Spoofing from Linux
 - We will do the attack with a user account. The account user1 has GenericAll/Fullcontrol/GenericWrite rights over the account user2.
- We need to control an account with enough permissions (e.g. GenericAll/FullControl or GenericWrite) to edit another account's sAMAccountName attribute


### **Impact**:

- Attackers can bypass **Kerberos authentication**, impersonate highly privileged accounts (like Domain Controllers), and escalate their privileges within the domain, potentially leading to **Domain Administrator** access.

### Tools
- BloodyAD
- getTGT.py 
- getST.py