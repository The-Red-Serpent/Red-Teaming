### What is PKINIT? (Public Key Cryptography for Initial Authentication)

Normally, Kerberos uses **symmetric encryption** (i.e., both sides know the same secret ‚Äî the password-derived key). But PKINIT changes that by introducing **asymmetric encryption** ‚Äî public/private key pairs.

### PKINIT Flow:

- The client uses an **X.509 certificate** (or a key) instead of a password.
    
- The private key stays on the client (e.g., in a TPM).
    
- The public key (or certificate) is used by the Domain Controller to verify the client‚Äôs identity.
    
- If the verification is successful ‚Üí TGT is issued.
    

This allows **passwordless login**, especially in environments with **PKI (Public Key Infrastructure)** using **AD CS (Active Directory Certificate Services)**.

### What is msDS-KeyCredentialLink?

This is an **Active Directory field** where the **user‚Äôs public keys** are stored.

### üìç Where does this come from?

When a user sets up **Windows Hello for Business (WHfB)** ‚Äî like setting up Face ID, fingerprint, or PIN login ‚Äî their Windows computer:

1. Creates a **public/private key pair**.
    
    - üîê Private key ‚Üí stored securely in the **TPM chip**.
        
    - üîì Public key ‚Üí stored in **Active Directory** in the `msDS-KeyCredentialLink` attribute.
        

This is the core of **Key Trust** login.

### Windows Hello for Business (WHfB) ‚Äì Login Without Password

Here‚Äôs what happens when the user logs in with WHfB:

1. They use a **PIN**, fingerprint, or face scan.
    
2. Their device uses the **private key** to sign something.
    
3. The DC finds the **public key** in `msDS-KeyCredentialLink`.
    
4. If the signature checks out ‚Üí ‚úÖ TGT is issued ‚Üí user is logged in.

### Step-by-Step:

1. **User enrolls** in WHfB.
    
    - They set up a PIN, fingerprint, or face scan.
        
    - The device generates a **key pair**: a private key and a public key.
        
        - üîê **Private key** ‚Üí stored securely in the device‚Äôs **TPM (Trusted Platform Module)**.
            
        - üîì **Public key** ‚Üí stored in **Active Directory (AD)** in an attribute called `msDS-KeyCredentialLink`.
            
2. **Next time the user logs in**:
    
    - They use their **PIN or biometrics**.
        
    - The private key is used to **sign a message**.
        
    - The Domain Controller (DC) checks the signature using the **stored public key**.
        
    - ‚úÖ If it matches ‚Üí user is authenticated ‚Üí gets a **Kerberos TGT** ‚Üí access granted.
        

> So: No password is sent or used. Even if someone steals your password ‚Äî they can't log in without your device.


## Trust Models: Certificate Trust vs Key Trust

There are **two ways** WHfB can be set up:

| Trust Model           | How it Works                                                                                                   |
| --------------------- | -------------------------------------------------------------------------------------------------------------- |
| **Certificate Trust** | The device gets a certificate from the organization‚Äôs Certificate Authority. Public key is in the certificate. |
| **Key Trust**         | Simpler. The public key is just stored directly in AD (`msDS-KeyCredentialLink`). No certificate needed.       |

### Shadow Credential Attack
#### Prerequisites:
- GenericAll , GenericWrite , over the target, or WriteProperty over the target's msDS KeyCredentialLink attribute and AddKeyCredentialLink
- Domain must have Active Directory Certificate Services and Certificate Authority configured.
- The Domain Functional Level should be Windows Server 2016 or above

The Shadow Credentials attack takes advantage of improper permissions on the msDS-KeyCredentialLink attribute, allowing attackers to inject their own public key into the attribute of a target user or computer account. we can also ‚Äúregisters‚Äù the attacker‚Äôs key as a valid authentication method for the target

#### Result
- We can get the TGT
Using the TGT, the attacker can:

- Perform lateral movement within the network.
- Use the¬†**S4U2self**¬†protocol to impersonate other users.
- Extract NTLM hashes from the Privilege Attribute Certificate (PAC)

### Tools
- pywhisker
- PKINITOOLS
- dacledit.py
- BloodyAD.py
- getnthash.py
- certipy-ad
- NTLMRelayx

[Shadow Credentials Attack - Hacking Articles](https://www.hackingarticles.in/shadow-credentials-attack/)
