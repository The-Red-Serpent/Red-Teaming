**SPN Jacking** is a **post-exploitation technique** that abuses **WriteSPN** permissions to:

- Reassign a **Service Principal Name (SPN)** from a legitimate service to a **compromised or attacker-controlled account**.
- This tricks Kerberos into encrypting TGS tickets for the wrong account.
- It's used to impersonate users or pivot across machines **without needing to crack passwords** (unlike traditional Kerberoasting).

### Conditions
- WriteSPN (right)
### What’s S4U?

- Part of **Kerberos Constrained Delegation**.
- Allows a service to **request a ticket** on behalf of a user **without needing the user's credentials**.
- It's controlled by the **msDS-AllowedToDelegateTo** attribute (lists allowed SPNs).

### Types of SPN Jacking
### Ghost SPN-Jacking

**Ghost SPN-Jacking** targets **orphaned SPNs**, which are SPNs that are no longer in use because the associated service or computer account has been deleted or renamed. These orphaned SPNs may still exist in the system, especially in systems configured for Kerberos Constrained Delegation.

### Live SPN-Jacking

**Live SPN-Jacking** involves more **active manipulation** of SPNs currently in use, rather than orphaned ones. The challenge here is that certain SPNs may already be actively used by other services. Therefore, the attacker needs to handle conflicts carefully. The goal is to alter SPNs of live services to make them point to an attacker-controlled machine.

### Ghost SPN-Jacking Attack - Summary

1. **Identify WriteProperty Permission**:
    
    - Check if a user (e.g., `gabriel`) has **WriteProperty** permission on the **ServicePrincipalName (SPN)** attribute.
        
    - Command:
        
    
    ```powershell
    Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? {$_.SecurityIdentifier -eq $(ConvertTo-SID gabriel)}
    ```
    
2. **Check Constrained Delegation**:
    
    - Verify if a computer (`SRV01`) is configured for **Constrained Delegation** (allows impersonation for specific services).
        
    - Command:
        
    
    ```powershell
    Get-DomainComputer -TrustedToAuth | select name, msds-allowedtodelegateto
    ```
    
3. **Search for Orphaned SPNs**:
    
    - Look for **orphaned SPNs** (SPNs no longer tied to active services) using the script `Get-ConstrainedDelegation`.
        
    - Command:
        
    
    ```powershell
    Get-ConstrainedDelegation -CheckOrphaned
    ```
    
4. **Take Note of Target SPNs**:
    
    - List current SPNs for the target machine (`WEB01`) to track changes.
        
    - Command:
        
    
    ```powershell
    Get-DomainComputer WEB01 | Select-Object -ExpandProperty serviceprincipalname
    ```
    
5. **Assign Orphaned SPN to Target**:
    
    - Assign orphaned SPNs (e.g., `dhcp/DATABASE01`) to the target machine (`WEB01`).
        
    - Command:
        
    
    ```powershell
    Set-DomainObject -Identity WEB01 -Set @{serviceprincipalname='dhcp/DATABASE01'} -Verbose
    ```
    



### Tools
| Tool/Script                    | Source                                                                          | Purpose                                                                           |
| ------------------------------ | ------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| **PowerView** (via PowerShell) | [PowerSploit](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon) | Enumerates SPN permissions, modifies SPNs, finds delegation.                      |
| **BloodHound** + **Neo4j**     | [BloodHound GitHub](https://github.com/BloodHoundAD/BloodHound)                 | Graphical enumeration of AD permissions (e.g. `WriteSPN`).                        |
| **Rubeus**                     | [Rubeus GitHub](https://github.com/GhostPack/Rubeus)                            | Performs Kerberos ticket requests and S4U impersonation (`s4u`, `tgssub`, `ptt`). |
| **Chisel**                     | [Chisel GitHub](https://github.com/jpillora/chisel)                             | Reverse SOCKS proxy for internal network access (pivoting).                       |
| **Proxychains4**               | Linux tool                                                                      | Forces traffic (e.g. Python scripts) through a SOCKS proxy.                       |
| **Impacket Tools**             | [Impacket GitHub](https://github.com/fortra/impacket)                           | For SPN manipulation, Kerberos abuse, ticket operations.                          |
| • `findDelegation.py`          | Impacket                                                                        | Finds accounts with constrained delegation.                                       |
| • `getST.py`                   | Impacket                                                                        | Requests S4U2self/S4U2proxy tickets impersonating users.                          |
| • `addspn.py` (from KrbRelayX) | [KrbRelayX GitHub](https://github.com/dirkjanm/KrbRelayX)                       | Add or clear SPNs from computer objects.                                          |
| • `describeTicket.py`          | Impacket                                                                        | Parses and describes Kerberos tickets.                                            |