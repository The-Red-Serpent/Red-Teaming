RDP supports a complete desktop experience, including remote sound, clipboard, printers, and file transfers with high-resolution graphics, which can be scaled down based on bandwidth. Only members of the Administrators or Remote Desktop Users groups can connect via RDP

### Actions we can perform:
- File Transfer
- Running Applications
- Printing 
- Audio And Video Streaming
- Clipboard Sharing
---

### Restricted Admin Mode  
Restricted Admin Mode is a security feature introduced by Microsoft to reduce the risk of credential theft during Remote Desktop Protocol (RDP) sessions. When enabled, it performs a network logon instead of an interactive logon. This prevents credentials from being cached on the remote machine.

**Key Characteristics:**

- Only applies when logging in with an account that is a member of the Administrators group.
- Prevents the caching of user credentials on the target machine.
- Uses network authentication rather than interactive logon.

**Security Implications:**

- Restricted Admin Mode can still allow the use of Pass-the-Hash (PtH) and Pass-the-Ticket (PtT) techniques for lateral movement if an attacker has administrator privileges.
- It may assist attackers in pivoting across systems once administrative  access is obtained.

**Registry Key Check:**

To determine whether Restricted Admin Mode is enabled, check the following registry key:

```
HKLM\SYSTEM\CurrentControlSet\Control\Lsa\DisableRestrictedAdmin
```

Use this command in the Command Prompt:

```
reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin
```

**Interpretation of the Registry Value:**

- Value = `0`: Restricted Admin Mode is enabled.
- Value = `1`: Restricted Admin Mode is disabled.
- Key does not exist: Restricted Admin Mode is disabled (default).

If the key is missing, the following error appears:

```
ERROR: The system was unable to find the specified registry key or value.
```

**To Enable Restricted Admin Mode:**

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /d 0 /t REG_DWORD
```

**To Disable Restricted Admin Mode:**

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /d 1 /t REG_DWORD
```

**Note:**  
Only users with administrative privileges can use or abuse Restricted Admin Mode. It is primarily useful to protect against credential theft but does not fully prevent credential reuse or lateral movement.


### Pass the Hash and Pass the Ticket for RDP
Once we confirm Restricted Admin Mode is enabled, or if we can enable it, we can proceed to perform Pass the Hash or Pass the Ticket attacks with RDP
**Why it matters for PtH and PtT:**

- When enabled, it supports authentication via NTLM hash or Kerberos tickets without caching credentials.
- This makes PtH and PtT feasible over RDP, as authentication can happen using hashes or tickets alone.
- This mode prevents credential harvesting on the destination system, but it also allows attackers to use reused credentials more easily.

### **Pass the Hash (PtH)** 
Pass the Hash is a technique where an attacker uses the **NTLM hash** of a user's password to authenticate instead of the actual password.

**Conditions for PtH:**

- The attacker must have the NTLM hash of a valid user account (typically an administrator).
- Restricted Admin Mode must be enabled on the target system to prevent interactive logon checks.
- A tool capable of using the hash for NTLM authentication is required (e.g., `xfreerdp` on Linux).

### **Pass the Ticket (PtT)** 
Pass the Ticket is an attack where an attacker uses a stolen or forged **Kerberos Ticket Granting Ticket (TGT)** to authenticate to services.

**Conditions for PtT:**

- The attacker must have access to a valid TGT for the user account.
- The attacker must be able to inject the ticket into a session (usually via `Rubeus` or `Mimikatz`).
- The ticket must be valid for the target domain and not expired.

**How it works:**

- A tool like **Rubeus** can request a TGT using the user’s hash and inject it directly into a session.
- The forged ticket is then used for authentication via Kerberos.
- Once injected, the attacker can use tools like `mstsc.exe` to initiate an RDP session under that user’s identity.


### ### **SharpRDP – Remote Command Execution via RDP**

**SharpRDP** is a post-exploitation tool that allows authenticated remote command execution over RDP without needing a graphical interface.

**Features:**

- Leverages `mstscax.dll` to instantiate and manage RDP sessions.
- Supports command execution using invisible Windows forms
- Allows execution of PowerShell or arbitrary commands remotely.

**Use Case:**

- Useful for lateral movement without triggering GUI-based session alerts.
- Helps avoid the need for traditional remote shell tools like PsExec.
- Can execute commands like payload downloads and reverse shells.

- we can use CleanRunMRU to clean all command records. To compile the tool we can use the built-in Microsoft CSC compiler tool.
```
C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe .\CleanRunMRU.cs
```