### What is Pre-Authentication in Kerberos Authentication Mechanism:
<p align="justify">Pre-authentication is a **security feature** within the Kerberos authentication flow, but it's **separate** from the core or default workflow of Kerberos authentication. Pre-authentication is an **optional step** that enhances security, and it typically needs to be **explicitly enabled** in the Kerberos configuration.</p>
#### Process Flow with Pre-Authenticaton:

- **User Authentication Process (AS-REQ Request)**:
    
    - When a user wants to log in and authenticate to the system, the **Kerberos client** (running on the user's device) sends an **Authentication Server Request (AS-REQ)** to the **Authentication Server (AS)**, which is part of the **Key Distribution Center (KDC)**.
- **What is Included in the AS-REQ**:
    
    - The **AS-REQ** typically contains **only the username** of the user who is trying to authenticate.
        - The **username** is sent to the **Authentication Server (AS)** to identify the user.
- **Password Handling (Pre-authentication, if enabled)**:
    
    - **The password is not directly sent over the network** in this request.
    - **What happens instead?** The **password** is used to derive a **key** (via hashing, usually with a password-derived key or a cryptographic method).
    - If **pre-authentication** is required (a security feature):
        - The **client** will generate a **timestamp** and **encrypt** it using a hash of the user's password. This ensures that the client **knows the password** without sending it over the network.
        - The **encrypted timestamp** (or challenge) is sent along with the **username** in the **AS-REQ**. This is the pre-authentication step where the client proves it knows the password.
- **What Happens at the Authentication Server (AS)**:
    
    - The **Authentication Server (AS)** checks the **username** against its records to find the **user's password**.
        
    - It **does not receive the password itself** but instead uses the **password** (or its hash) stored in its database to derive the same **key** that the client used to **encrypt the timestamp**.
        
    - If the **pre-authentication** timestamp is correct (i.e., the server can successfully decrypt the encrypted timestamp using the password-derived key), the **AS** knows the client is legitimate.

#### Process flow Without Pre-Authentication:
1. **User Authentication Request**:
    
    - The **user** (or client) initiates authentication by sending an **Authentication Server Request (AS-REQ)** to the **Authentication Server (AS)**, which is part of the **Key Distribution Center (KDC)**.
    - The **AS-REQ** contains:
        - The **username** of the user trying to authenticate.
        - **No pre-authentication data** (like the timestamp or challenge response). The client does not need to prove it knows the password in advance.
2. **Authentication Server (AS) Checks Username**:
    
    - The **Authentication Server (AS)** checks the **username** against its database to see if it exists.
    - Since **pre-authentication is disabled**, the AS does not require any proof (like a challenge or encrypted timestamp) from the client to verify the password or identity.
3. **AS Issues the Ticket Granting Ticket (TGT)**:
    
    - If the **username** exists and the client is authorized, the **AS** will proceed to issue a **Ticket Granting Ticket (TGT)** for the user.
    - The **TGT** contains information like:
        - The **user's identity**.
        - A **session key** used for future communication with the KDC.
        - The **ticket expiration time**.
    - The **TGT is encrypted** using a **key derived from the user's password** (or another shared secret).
        - **The password itself is never sent over the network**. Instead, the password is used to derive a **key** that encrypts the TGT.

**Sensitive Data in the AS-REP**:

- The **AS-REP** contains sensitive data, including the **TGT** and an **encryption key** used to encrypt part of the TGT (specifically a **session key**).
- Importantly, **some segments of this response** are **encrypted with the user's password hash** (the key derived from the userâ€™s password).





- By default pre-authentication is enabled by default to all accounts. if not enabled an attacker can request a TGT on behalf of any user and get the TGT and crack the password offline

#### Enumerating users with Pre-Auth Disabled:
- This command is used when we are in a machine inside AD  using powerview script but needs high privilege
```
Get-DomainUser -PreauthNotRequired | select UserPrincipalName
```

- We can use Impacket command but we need usernames of the account since we do this in a black box perspective. We can also pass a list of usernames if we dunno any user account
```
impacket-GetNPUsers -dc-ip ip-of-dc -request -outputfile hashes.asreproast domain-name/username_used_for_Auth
```

Tools used : Kerbrute, Impacket, Rubeus, Ker-brute Enum etc

