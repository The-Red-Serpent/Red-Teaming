
### **What is an MFP?**

- MFPs are devices like printers, copiers, and scanners that connect to a corporate network. They offer multiple functions like printing, scanning, and emailing documents. Many MFPs have LDAP, SMTP, and network share integrations to facilitate these features.

**Why Target Them?** MFPs store credentials (e.g., LDAP or SMTP credentials) and often have weak default security settings, making them an easy entry point into a network.

### Working:
#### How the Pass-Back Attack is Performed: Step-by-Step

#### Step 1: Identify the Target MFP
- **Objective:** Find an MFP on the network to target.
- **How to Do It:**
  1. Scan the network using a tool like `nmap` to locate devices (e.g., `nmap -sn 192.168.1.0/24` to discover hosts).
  2. Look for open ports commonly associated with MFPs, such as:
     - Port 80 or 443 (HTTP/HTTPS for the Embedded Web Service, or EWS).
     - Port 9100 (common for printer communication).
     - Port 389 (LDAP, if already configured).
  3. Identify the MFP’s IP address (e.g., 192.168.1.50) and confirm it’s a printer/scanner by accessing its web interface or checking its response.
- **Example:** You find an HP Color LaserJet MFP at `192.168.1.50`.

---

#### Step 2: Gain Access to the Embedded Web Service (EWS)
- **Objective:** Log into the MFP’s web-based admin interface (EWS) to modify settings.
- **How to Do It:**
  1. Open a browser and navigate to the MFP’s IP address (e.g., `http://192.168.1.50` or `https://192.168.1.50`).
  2. Attempt login with default credentials from the MFP’s vendor:
     - HP: `admin` / `admin` or `admin` / (blank).
     - Ricoh: `admin` / (blank).
     - Canon: `ADMIN` / `canon`.
     - Epson: `EPSONWEB` / `admin`.
  3. If defaults fail, use tools like PRET (Printer Exploitation Toolkit) to exploit vulnerabilities:
     - Install PRET: `git clone https://github.com/RUB-NDS/PRET.git`.
     - Run: `python pret.py -i 192.168.1.50 pjl` (try PJL, PS, or PCL protocols).
     - Look for info disclosure or admin access.
  4. Alternatively, use Praeda (`git clone https://github.com/percx/Praeda.git`) for automated MFP exploitation.
- **Outcome:** You’re logged into the EWS admin panel.

---

#### Step 3: Locate the LDAP Settings in the EWS
- **Objective:** Find where LDAP configuration is stored to redirect authentication.
- **How to Do It:**
  1. In the EWS, navigate to the **Networking** or **Access Control** section (varies by vendor).
     - For HP MFPs, it’s often under “Networking” > “Access Control” or “LDAP Setup.”
  2. Look for fields like:
     - **LDAP Server Address** (e.g., currently set to `192.168.1.100`).
     - **Port** (usually 389 for LDAP).
     - **Username/Password** (may be stored or passed from user input).
  3. Note the existing settings for reference.
- **Example:** You see the LDAP Server Address is `192.168.1.100` and the port is `389`.

---

#### Step 4: Set Up Your Malicious LDAP Server
- **Objective:** Create a fake LDAP server to capture credentials sent by the MFP.
- **How to Do It:**
  1. **Choose Your Machine:** Use a system you control (e.g., a Kali Linux VM) with a known IP (e.g., `192.168.1.200`).
  2. **Simple Option - Netcat Listener:**
     - Open a terminal and run: `nc -l 389` (listens on port 389 for incoming LDAP traffic).
     - This captures raw data but won’t fully emulate LDAP.
  3. **Better Option - Fake LDAP Server:**
     - Install an LDAP server like OpenLDAP (`sudo apt install slapd ldap-utils` on Linux).
     - Configure it minimally to accept connections (basic setup is fine for this attack).
     - Alternatively, use a tool like `ldapserver` from GitHub or a Python script to log incoming credentials.
  4. Ensure your machine is reachable from the MFP (same network or routed correctly).
- **Outcome:** Your malicious server is ready at `192.168.1.200:389`.

---

#### Step 5: Modify the LDAP Server Address in the EWS
- **Objective:** Redirect the MFP’s LDAP queries to your fake server.
- **How to Do It:**
  1. In the EWS LDAP settings, replace the legitimate LDAP Server Address (`192.168.1.100`) with your malicious server’s IP (`192.168.1.200`).
  2. Keep the port as `389` (or match the original setting).
  3. Save the changes (click “Apply” or “Save”).
- **Outcome:** The MFP now sends LDAP authentication attempts to your server instead of the real one.

---

#### Step 6: Capture Credentials
- **Objective:** Harvest credentials when the MFP authenticates to your server.
- **How It Works:**
  1. **User Authentication Scenario:**
     - An employee uses the MFP (e.g., to scan-to-email) and enters their credentials at the control panel.
     - The MFP sends these credentials to your server (`192.168.1.200:389`).
  2. **Stored Credentials Scenario:**
     - If the MFP is configured to store LDAP credentials (e.g., for email lookups), it sends those automatically during the next query.
  3. **Monitor Your Server:**
     - With Netcat: Watch the terminal for incoming data (e.g., username/password in plain text or hashed form).
     - With a fake LDAP server: Check logs or script output for captured credentials.
- **Example Output (Netcat):** You might see `username=jdoe password=P@ssw0rd` sent over the connection.
- **Outcome:** You’ve captured valid network credentials.

---

#### Step 7: Clean Up (Ethical Consideration)
- **Objective:** Restore the MFP to its original state (if this is a legitimate pen test).
- **How to Do It:**
  1. Return to the EWS and revert the LDAP Server Address to `192.168.1.100`.
  2. Save the original settings.
  3. Stop your malicious server (`Ctrl+C` in Netcat or shut down the LDAP service).
- **Outcome:** No evidence of tampering remains.

---

#### How to setup ldap on kali
Here are the commands to set up an LDAP server on Kali Linux:

### 1. Install OpenLDAP and Utilities:

```bash
sudo apt update
sudo apt install slapd ldap-utils
```

### 2. Reconfigure slapd (if you need to reconfigure it):

```bash
sudo dpkg-reconfigure slapd
```

### 3. Check if the LDAP server is running:

```bash
sudo systemctl status slapd
```


### Tools:
- pret 
- prada
- [for more](https://www.hacking-printers.net/wiki/index.php/Printer_Security_Testing_Cheat_Sheet)
