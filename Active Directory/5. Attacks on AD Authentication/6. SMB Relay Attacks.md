
### SMB Authentication Process

### SMB Authentication in Detail

1. **NTLM Authentication**:
    
    - **NTLM** (NT LAN Manager) is an older authentication protocol used by SMB for authentication. It’s based on a challenge-response mechanism.
    - **Steps in NTLM Authentication**:
        - The client sends the username to the server.
        - The server sends a random challenge (a nonce) back to the client.
        - The client computes a hash of the password and the challenge and sends it back.
        - The server compares the response with its own computed value using the password hash stored in its database.
    
    **Drawbacks of NTLM**:
    
    - Vulnerable to various attacks like **Man-in-the-Middle** and **Pass-the-Hash**.
    - **LM (LAN Manager) Hashes** used by NTLM are weak and prone to cracking.
2. **Kerberos Authentication**:
    
    - **Kerberos** is a more secure authentication protocol introduced in SMB 2.0 and used primarily in Active Directory environments.
    - **Steps in Kerberos Authentication**:
        - The client first requests a **Ticket Granting Ticket (TGT)** from the **Key Distribution Center (KDC)**.
        - The KDC verifies the client’s credentials and sends back the TGT, which the client stores in memory.
        - The client then requests access to a specific service (e.g., file sharing) from the KDC.
        - The KDC responds with a **Service Ticket** that the client can use to authenticate to the SMB server.
        - The client sends the service ticket to the SMB server.
        - The server decrypts the ticket and grants access if everything is valid.

### What is SMB Relay Attacks
<p align="justify">An **SMB Relay Attack** is a type of **Man-in-the-Middle (MitM)** attack that targets the **Server Message Block (SMB)** protocol, commonly used in Windows networking. The attacker intercepts and relays authentication traffic between a client and a server in order to gain unauthorized access to a system.</p>

### **Steps of an SMB Relay Attack**

Here's how the attack works, starting from the beginning:

#### **Step 1: Attacker’s Positioning**

1. **The attacker is positioned between the victim (client) and the SMB server**. This could be done via:
    - **Man-in-the-Middle (MITM)**: The attacker can place themselves in the middle of the communication channel between the victim client and the legitimate SMB server.
    - **Network Spoofing**: The attacker can create a fake SMB server or use **DNS spoofing** or **NetBIOS name resolution** to trick the victim into thinking the attacker's system is the legitimate server.

#### **Step 2: Victim Initiates Connection**

2. The victim **tries to connect to an SMB resource** (e.g., a shared folder on a server). The victim’s system sends an authentication request (e.g., **NTLM** or **Kerberos**) to the attacker’s system (because the attacker has tricked the client into believing it's the real server).

#### **Step 3: The Attacker Relays the Request**

3. The attacker **captures the victim's authentication request** and then **relays it** to the actual **target SMB server** (the intended destination of the request). The attacker acts as an intermediary, forwarding the credentials from the victim to the target server.

#### **Step 4: Target Server Responds**

4. The **target SMB server** processes the authentication request, as it normally would, and **grants access** to the attacker, thinking that the request is legitimate. If the authentication succeeds (e.g., with NTLM), the server will send the response (such as an SMB session setup success).

#### **Step 5: Attacker Gains Access**

5. Since the **target SMB server believes the authentication came from a legitimate client**, it **grants the attacker access** to the resource that the victim was attempting to access. The attacker now has the same permissions as the victim and can **perform malicious actions** like stealing files, modifying data, or impersonating the user.


### Requirements
- Need to identify the version of smb used
- smb must run on respective ports
- The target must not enforce or enable SMB signing.
- For valuable outcomes, the relayed user’s credentials must have local admin status on the machine.

### How to check for SMB signing enabled or not
- can use smb to find smb hosts
```
nmap --script=smb2-security-mode.nse
```
- need to turn off smb http off in responder

- This will give is ntlm hashes or Sam database hashes or we can get an interactive shell using ntlmrelayx
### Tools
- Responder- to capture
- NTLMRelayx-  To relay\
- smbtrap
- smbmap

### Mitigations:
- enable smb signing on all devices
- Disable ntlm authentication on the network
- Limit domain admin for specific tasks
- Local admin restriction
