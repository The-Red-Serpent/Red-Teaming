## What is Single-Sign-On:
Single sign-on (SSO) is an authentication method that enables users to securely authenticate with multiple applications and websites by using just one set of credentials. example :  service ticket

 Kerberos authentication make use of SSO , so the password hashes are stored somewhere to issue a TGT. In modern versions of Windows, these hashes are stored in the Local Security Authority Subsystem Service (LSASS) memory space.
- we need SYSTEM or admin privileges to access these hashes
### What is LSASS Memory Space?

The **LSASS (Local Security Authority Subsystem Service) memory space** is the **portion of RAM used by the LSASS process (`lsass.exe`) to store authentication-related data**. This includes **password hashes, Kerberos tickets, and cached credentials**.

### What is Stored in LSASS Memory?

The **LSASS memory space** contains:

#### üîë Authentication Credentials

- **NTLM password hashes** (used for authentication in Windows).
- **Kerberos tickets (TGT/TGS)** (used for Single Sign-On in AD).
- **Cached plaintext passwords** (if stored in memory).

#### üîç Security Tokens & Session Information

- **Access tokens** (used for impersonation and privilege management).
- **User session details** (logon sessions, domain authentication info).

##### Attackers target **LSASS memory** to **dump credentials** and perform:

- **Pass-the-Hash (PtH)** ‚Äì Reusing NTLM hashes to authenticate.
- **Pass-the-Ticket (PtT)** ‚Äì Using stolen Kerberos tickets for SSO.
- **Kerberoasting** ‚Äì Extracting and cracking service account credentials.

#### Tools for Extracting LSASS Credentials:

- **Mimikatz**: The most well-known tool for dumping LSASS memory.
- **ProcDump**: Can be used to create a memory dump of LSASS for offline analysis.
- **Rubeus**: Specialized for Kerberos ticket extraction and manipulation.
- **Dumping via Direct Syscalls (EDR Evasion)**: Some modern tools use **direct syscalls** to avoid detection by EDR/AV solutions.


### **Public Key Infrastructure (PKI) in Active Directory**

In **Active Directory (AD)**, Microsoft provides a built-in **Public Key Infrastructure (PKI)** service called **Active Directory Certificate Services (AD CS)**. It allows organizations to use **digital certificates** for authentication, encryption, and securing communications.

üìå **Key Role of AD CS in AD:**  
‚úÖ Issues and manages **digital certificates** for users, computers, and services.  
‚úÖ Allows **certificate-based authentication** (e.g., **smart card logins**).  
‚úÖ Enables **HTTPS encryption** for web servers.

---

## **How Certificates Work in AD CS**

1Ô∏è‚É£ **Certification Authority (CA)**:

- A server running **AD CS** acts as a **Certification Authority (CA)**.
- It issues and revokes **digital certificates** for **trusted users and computers**.

2Ô∏è‚É£ **User Authentication via Certificates**:

- Instead of using a password, users can **log in using a certificate** (e.g., smart card login).
- The CA **validates the certificate** to ensure it's authentic.

3Ô∏è‚É£ **Secure Communications**:

- Web servers use **certificates to enable HTTPS** encryption.
- AD-integrated services (e.g., Wi-Fi authentication) can also use **certificate-based security**.

---

## **Exporting Private Keys in AD CS**

üìå **Private Key Protection in AD CS**:

- Normally, private keys are **marked as non-exportable** for security.
- This prevents users (even administrators) from **exporting private keys** from a certificate.

üìå **Bypassing Non-Exportable Private Keys**:  
Attackers can **bypass** these restrictions and **export private keys** using:

- **Mimikatz‚Äôs crypto module** (`crypto::capi` or `crypto::cng`).
- **Patching CryptoAPI** or **KeyIso service** to extract private keys.

üî¥ **Mimikatz Command to Extract Non-Exportable Keys**:

```powershell
mimikatz.exe "crypto::capi" "crypto::cng" exit
```

This allows an attacker to extract **private keys** from certificates that were supposed to be protected.

---

## **Why is This a Security Risk?**

If an attacker **steals a private key**, they can:  
‚úÖ **Decrypt encrypted communications** (SSL/TLS, emails, etc.).  
‚úÖ **Impersonate legitimate users or servers**.  
‚úÖ **Bypass smart card authentication** (if smart card logins are used).

