https://notes.benheater.com/books/active-directory
https://zer1t0.gitlab.io/posts/attacking_ad/

## ğŸŒ Domain

A **domain** in Active Directory is like a **private space or container** that holds objects such as **users, computers, and groups**. Each domain:

- Has its own set of **configurations**, **security policies**, and **administrative control**.
- Has its own set of **administrators** who manage the objects within it.

---

## ğŸ—‚ï¸ Organizational Units (OUs)

**Organizational Units (OUs)** are **containers within a domain** that organize and manage objects like users, groups, and computers. Key points:

- Help group objects logically (e.g., by **department**, **location**, or **role**).
- Allow **separate Group Policy Objects (GPOs)** to be applied for **granular control**.
---

## ğŸŒ² Forest

A **forest** is the **topmost logical container** in Active Directory and can contain **one or more domains**.
- All domains in a forest share:
    - A **common schema**
    - A **configuration**
    - A **global catalog**

- Domains within a forest **trust each other by default**, allowing users to access resources across domains without needing manual trust setups.
## ğŸ¤ Trust

A **trust** is a **relationship** that enables **authentication and resource access** between two domains or forests.

---

### ğŸ”— Types of Trust in AD

#### A. Domain Trusts

1. **Parent-Child Trust**
- Automatically created when a **child domain** is added to a **parent domain**

2. **Tree-Root Trust**
- Automatically created when a **new domain tree** is created within the same forest.

3. **External Trust**
- Created manually between domains in **different forests** or **external organizations**.

4. **Shortcut Trust**
 - Manually created between **two domains in the same forest** to**optimize authentication performance**.
 
5. **Forest Trust**
- Created between **two separate forests**.
- Can be **one-way** or **two-way**.
---

#### B. Trust Directions

|**Type**|**Description**|
|---|---|
|**One-Way Trust**|Only one domain trusts the other. If Domain A trusts Domain B, A users can access B resources, but not vice versa.|
|**Two-Way Trust**|Both domains trust each other, allowing mutual access.|


## ğŸ“˜ Active Directory Terminology

### ğŸ§© Object

An **object** is a distinct entity in AD, such as a **user**, **computer**, or **group**.

### ğŸ·ï¸ Attributes

Each object has **attributes** (properties). For example:

|**Object Type**|**Attribute**|**Description**|
|---|---|---|
|**User**|name|Full name of the user|
||email|User's email address|
||phone number|User's phone number|
||group memberships|Groups the user belongs to|
||password|(Stored as hashed)|
|**Computer**|hostname|Device name|
||operating system|Installed OS|
||IP address|Assigned IP|
|**Group**|group name|Name of the group|
||group type|Security or Distribution|
||group members|List of members|

## 1. **User Account**

### **Definition:**

Represents a **human user** in Active Directory â€” used for logging into systems and accessing resources.

### ğŸ” **Identification:**

- `objectClass`: `user`
    
- `sAMAccountType`: `0x30000000`
    
- `sAMAccountName`: **does not end with `$`**
    
- `userAccountControl`: typically `512` (UF_NORMAL_ACCOUNT)
    

---

## ğŸ–¥ï¸ 2. **Computer Account**

### **Definition:**

Represents a **domain-joined computer** (e.g., PC, server) â€” used for machine authentication and policy application.

### ğŸ” **Identification:**

- `objectClass`: `computer`
    
- `sAMAccountType`: `0x30000001`
    
- `sAMAccountName`: **ends with `$`** (e.g., `WIN10-PC$`)
    
- `userAccountControl`: `4096` (UF_WORKSTATION_TRUST_ACCOUNT)
    

---

## ğŸ”§ 3. **Service Account**

### âœ… **Definition:**

A **user account** intended to run services or applications â€” not meant for human interaction.

### ğŸ” **Identification:**

- `objectClass`: `user`
    
- **sAMAccountName** often includes `svc`, `service`, or `app`
    
- May have `ServicePrincipalName` set (SPN)
    
- `userAccountControl`: often includes `DONT_EXPIRE_PASSWORD`
    
- Interactive login typically **disabled**
    

---

## ğŸ” 4. **Trust Account**

### **Definition:**

A special AD object used to establish **trust relationships** between domains or forests.

### ğŸ” **Identification:**

- `objectClass`: `trustedDomain`
    
- Found under: `CN=System,DC=domain,DC=com`
    
- Managed using: `Get-ADTrust`, `domain.msc`, or `netdom`
    


### ğŸ§  Schema

Defines **which object types** exist and **which attributes** they can have. It's the **blueprint** of AD.

---

### ğŸ†” GUID (Global Unique Identifier)
<p align="justify">`Global Unique Identifier`  is a unique 128-bit value assigned when a domain user or group is created. This GUID value is unique across the enterprise, similar to a MAC address. Every single object created by Active Directory is assigned a GUID, not only user and group objects. The GUID is stored in theÂ `ObjectGUID`Â attribute</p>

- A **128-bit unique value** assigned to each object (users, computers, groups, etc.).
- Stored in the `ObjectGUID` attribute.

---

### ğŸ‘¤ Security Principal

An entity (user, group, computer, service) that can be **authenticated** and **authorized** in AD.

### ğŸ” SID (Security Identifier)

- Unique identifier used to manage **security permissions**.
- Every security principal has a SID.

#### Well-known SIDs:

|**SID**|**Name**|**Description**|
|---|---|---|
|S-1-0-0|Nobody|No security principal|
|S-1-1-0|Everyone|All users, including anonymous|
|S-1-5-11|Authenticated Users|Authenticated identities|
|S-1-5-18|Local System|Operating system service account|
|S-1-5-21domain-512|Domain Admins|Domain administrators|
|S-1-5-32-544|Administrators|Full system control|
|S-1-5-32-545|Users|Authenticated users|
|S-1-5-32-546|Guests|Limited privileges|
|S-1-5-32-551|Backup Operators|Can backup/restore all files|

---

### ğŸ‘¥ sAMAccountName

The **logon username** used within a domain for authentication.

---

### ğŸ›¡ï¸ Read-Only Domain Controller (RODC)

- A **read-only** copy of the domain controller.
- Used in **less secure** or **remote** environments.
- Supports **authentication** but **no write operations**.

---

### ğŸ·ï¸ SPN (Service Principal Name)

A unique name identifying an instance of a service, used for **Kerberos authentication**.
An **SPN (Service Principal Name)** is a **unique identifier** for a service instance in Active Directory. It maps a service instance to a service logon account, allowing **Kerberos authentication** to locate and authenticate services.

---

### âš™ï¸ GPO (Group Policy Object)

A set of **rules and settings** that define behavior for users and computers.

- Used to enforce security, configurations, software installations, etc.

---

### ğŸ§¾ ACE & SACL

- **Access Control Entry (ACE)**: Defines individual user/group permissions in an **Access Control List (ACL)**.
- **System Access Control List (SACL)**: Logs **access attempts** (successful or failed) for auditing purposes.

---

### ğŸª¦ Tombstone

Tombstone is a container object in AD that holds deleted AD objects. When an object is deleted and the Recycle Bin is not enabled, the object enters the **Tombstone state** as a part of Active Directoryâ€™s internal process for marking deleted objects. When an object is deleted from AD, the object remains for a set period of time known as theÂ `Tombstone Lifetime,`Â and theÂ `isDeleted`Â attribute is set toÂ `TRUE`. Once an object exceeds theÂ `Tombstone Lifetime`, it will be entirely removed.

- A **deleted object placeholder** in AD.
- Objects remain in **tombstoned** state for a **defined lifetime** before full deletion.
- Attribute `isDeleted = TRUE`.

### ğŸ—‘ï¸ Active Directory Recycle Bin
 It is a feature that allows for the recovery of deleted AD objects, such as users, groups, and organizational units, without requiring a system restore. When an object is deleted, it enters a "soft delete" state where its data is preserved, and it can be restored with all its attributes, including group memberships and passwords 

- Allows recovery of deleted AD objects with **attributes and group memberships preserved**.
- Must be **enabled manually**.
- Default retention: **180 days**.

### ğŸ“‚ SYSVOL

- Contains public AD files like **Group Policy**, **scripts**, etc.
- Replicated across domain controllers via **FRS** or **DFSR**.

### ğŸ›‘ AdminCount

Indicates whether an object is a **protected privileged account**.

- `adminCount = 1` â†’ Protected (e.g., Domain Admins)
- `adminCount = 0` or not set â†’ Unprotected
- Controlled by **SDProp** (Security Descriptor Propagation)

### ğŸ› ï¸ ADSI Edit

A **low-level editing tool** for Active Directory, used to view or modify **any attribute** of any AD object.

- More powerful and dangerous than ADUC (Active Directory Users and Computers).
- Typically used for advanced recovery, troubleshooting, or attribute manipulation.

### NTDS.DIT 

It is a critical database file in Active Directory, stored on every **Domain Controller** (DC) in the `C:\Windows\NTDS\` directory. It contains all the essential information about the Active Directory environment, including:

	- **User and group objects** (like user accounts and groups)
	- **Group membership**
	- **Password hashes** for all users in the domain (this is particularly important to attackers)


## Foreign Security Principal

 ``Foreign Security Principal (FSP)`` in Active Directory is an object that represents a security principal (such as a user, group, or computer) from a **trusted external forest**. When a security principal from a different domain or forest is added to a group in the current domain, an FSP is automatically created to store information about that external object.

## Relative Identifier
A **RID** is the last part of a **Security Identifier (SID)** in Windows, used to uniquely identify a user, group, or computer **within a domain**.Each object in a domain shares the same domain SID prefix, and the **RID** differentiates them.

| Part      | Meaning                                       |
| --------- | --------------------------------------------- |
| S-1-5     | Standard SID prefix                           |
| 21-123... | Domain ID (same for all users in that domain) |
| **500**   | â† This is the **RID**                         |

#### Common RIDs:

| RID   | Who it belongs to     |
| ----- | --------------------- |
| 500   | Administrator account |
| 501   | Guest account         |
| 512   | Domain Admins group   |
| 1000+ | Normal user accounts  |

## Global Catalog
Active Directory uses the Global Catalog (GC), which is a copy of all theÂ Active Directory objects in the forest, to let users search forÂ directory informationÂ across all the domains in the forest.

## What is a global catalogÂ server?

AÂ DC in an Active Directory (AD) network stores full information only related to the domain it is in. To locate objects outside its domain is beyond its scope. Hence, there is a need for a server called a global catalog server. The global catalog contains a partial representation of all objects in the entire forest. Hence, a global catalog server has the potential to search objects from any domain within the forest it is in.

### MachineAccountQuota in Active Directory?

**`MachineAccountQuota` (MAQ)** is an **Active Directory domain attribute** that controls **how many computer accounts a non-privileged (domain) user is allowed to create** in the domain.

## What is Beacon Object File
