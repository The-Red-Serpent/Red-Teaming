Kerberos is a Network Authentication Protocol used to authenticate users and services on a untrusted network.
#### Features:
1. Passwords are never sent over the network
2. Encryption Keys are never directly exchanged

##### Key Distribution Center:
<p align="justify">Key Distribution Center (KDC) acts as a trusted third-party authority that is responsible for authenticating users and issuing tickets to allow access to services. The KDC contains a database of users (principals) with their username and password-derived keys (hashed passwords). When a user first sets up their password, the password is hashed (using a hashing algorithm) and stored securely in the KDC database.</p>

### The KDC consists of two main parts:
- Authentication Server
- Ticket Granting Service

### **Authentication Server (AS)**

The **Authentication Server** is responsible for verifying the identity of users during the initial login process. Below is a detailed breakdown of its operation:

#### 1. **User Authentication Process**:

- When a user attempts to authenticate to the system, the client sends an **Authentication Server Request (AS-REQ)** to the **Authentication Server (AS)**.
- The **AS-REQ** typically contains:
    - Its name (the client principal name)
	- The realm name
	- The desired service, which is in case of `AS-REQ` always `KRBTGT`
	- A randomly generated value (called a _Nonce_)
	- if pre-authentication is configured, an encrypted timestamp with the clients secret
#### 2. **Verification of User**:

- Upon receiving the **AS-REQ**, the **AS** performs the following actions:
    - It looks up the password associated with the specific user in the **ntds.dit** file.
    - The **AS** attempts to **decrypt the timestamp** using this hash.
    - If the decryption is successful and the timestamp is valid (not a duplicate), the authentication is considered **successful**.

#### 3. **Issuance of Ticket Granting Ticket (TGT)**:

- If the user is successfully authenticated, the **AS** generates a **Ticket Granting Ticket (TGT)** for the user.
- The **TGT** contains:
     - The client's identity (principal name). 
    - A **TGT session key** (also called client/TGS session key)randomly generated by the KDC; used for subsequent secure communication between the client and the Ticket-Granting Service (TGS).
    - Timestamps, validity period (default ~10 hours).

#### 4. **Encryption of the TGT**:

- The **TGT** is encrypted using a secret key associated with the **krbtgt** account, which is an account known only to the KDC (Key Distribution Center).
- Since the **krbtgt** key is only known to the KDC, it cannot be decrypted by the client.
- The **TGT** provides the client with the ability to request **service tickets** without needing to re-enter credentials, ensuring both convenience and security.

#### 5. **TGT Validity and Renewal**:

- By default, the **TGT** is valid for **ten hours**.
- After this period, the **TGT** will require a **renewal** to extend its validity.


#### 2. **Ticket Granting Service (TGS)**:

The **Ticket Granting Service** is responsible for issuing **service tickets**. Once a client has a valid **TGT** (obtained from the AS), they can use it to request access to specific services in the network.

- The client constructs a **Ticket Granting Service Request (TGS-REQ)** packet that consists of the following:
    - The current user
    - A timestamp encrypted with the session key
    - The name of the resource
    - The encrypted **TGT**

The **ticket-granting service** on the KDC receives the **TGS-REQ**, and if the resource exists in the domain, the **TGT** is decrypted using the secret key known only to the KDC. The session key is then extracted from the **TGT** and used to decrypt the username and timestamp of the request. 

The KDC performs several checks:
- The **TGT** must have a valid timestamp.
- The username from the **TGS-REQ** has to match the username from the **TGT**.
- The client IP address needs to coincide with the **TGT** IP address.

If this verification process succeeds, the **Ticket Granting Service** responds to the client with a **Ticket Granting Server Reply (TGS-REP)**. This packet contains three parts:
- The name of the service for which access has been granted.
- A session key to be used between the client and the service.
- A **service ticket** containing the username and group memberships along with the newly created session key.

The service ticketâ€™s **service name** and **session key** are encrypted using the original session key associated with the creation of the **TGT**. The service ticket is encrypted using the password hash of the **service account** registered with the service in question.


![image](https://i0.wp.com/sheerazali.com/wp-content/uploads/2021/05/Screenshot-2021-05-12-at-6.52.46-PM.png?resize=1416%2C1536&ssl=1)


